<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victron ESS Controller</title>
    <style>
        /* Victron Blue Theme */
        :root {
            --victron-blue: #0077BE;
            --victron-light-blue: #4DA6D9;
            --victron-dark-blue: #005A8B;
            --victron-gray: #F5F5F5;
            --victron-dark-gray: #333333;
            --victron-green: #28A745;
            --victron-orange: #FD7E14;
            --victron-red: #DC3545;
            --victron-yellow: #FFC107;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--victron-gray) 0%, #E8F4F8 100%);
            color: var(--victron-dark-gray);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, var(--victron-blue) 0%, var(--victron-light-blue) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
        }

        .header .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.3rem;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,119,190,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.8rem;
            border-bottom: 2px solid var(--victron-gray);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .battery-icon { background: linear-gradient(135deg, var(--victron-green), #20C997); }
        .inverter-icon { background: linear-gradient(135deg, var(--victron-blue), var(--victron-light-blue)); }
        .system-icon { background: linear-gradient(135deg, var(--victron-dark-blue), var(--victron-blue)); }
        .protection-icon { background: linear-gradient(135deg, var(--victron-orange), #FFB347); }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--victron-dark-blue);
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.6rem 0;
            padding: 0.4rem 0;
            border-bottom: 1px solid #F0F0F0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #666;
            flex: 1;
        }

        .metric-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--victron-dark-gray);
            text-align: right;
            min-width: 80px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online { background: var(--victron-green); }
        .status-offline { background: var(--victron-red); }
        .status-warning { background: var(--victron-orange); }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--victron-gray);
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--victron-green), var(--victron-light-blue));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .power-flow {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 300;
            margin: 1rem 0;
            color: var(--victron-blue);
        }

        .power-direction {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .wide-card {
            grid-column: span 2;
        }

        .protection-flags {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .flag-item {
            background: #F8F9FA;
            padding: 0.5rem;
            border-radius: 6px;
            text-align: center;
            font-size: 0.8rem;
        }

        .flag-active {
            background: var(--victron-red);
            color: white;
        }

        .footer {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-size: 0.9rem;
        }

        .refresh-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--victron-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,119,190,0.3);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--victron-dark-blue);
            transform: scale(1.1);
        }

        @media (max-width: 1200px) {
            .wide-card {
                grid-column: span 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                margin: 1rem auto;
            }
            .header {
                padding: 1rem;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .power-flow {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Victron Energy ESS Controller</h1>
        <div class="subtitle">ESP32 MultiPlus Energy Storage System</div>
    </div>

    <div class="container">
        <!-- Battery Status Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon battery-icon">üîã</div>
                <div class="card-title">Battery Management System</div>
            </div>
            <div class="metric">
                <span class="metric-label">State of Charge</span>
                <span class="metric-value" id="battery_soc">---%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="battery-progress" style="width: 0%"></div>
            </div>
            <div class="metric">
                <span class="metric-label">Voltage</span>
                <span class="metric-value" id="battery_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">Current</span>
                <span class="metric-value" id="battery_current">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Temperature</span>
                <span class="metric-value" id="battery_temperature">--- ¬∞C</span>
            </div>
            <div class="metric">
                <span class="metric-label">State of Health</span>
                <span class="metric-value" id="battery_soh">---%</span>
            </div>
            <div class="metric">
                <span class="metric-label">Charge Voltage Limit</span>
                <span class="metric-value" id="battery_charge_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">Charge Current Limit</span>
                <span class="metric-value" id="battery_charge_current_limit">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Discharge Current Limit</span>
                <span class="metric-value" id="battery_discharge_current_limit">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Manufacturer</span>
                <span class="metric-value" id="battery_manufacturer">---</span>
            </div>
        </div>

        <!-- MultiPlus Inverter Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon inverter-icon">‚ö°</div>
                <div class="card-title">MultiPlus Inverter/Charger</div>
            </div>
            <div class="metric">
                <span class="metric-label">DC Voltage</span>
                <span class="metric-value" id="multiplus_dc_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">DC Current</span>
                <span class="metric-value" id="multiplus_dc_current">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">AC Voltage (RMS)</span>
                <span class="metric-value" id="multiplus_ac_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">AC Frequency</span>
                <span class="metric-value" id="multiplus_ac_frequency">--- Hz</span>
            </div>
            <div class="metric">
                <span class="metric-label">Inverter Power</span>
                <span class="metric-value" id="multiplus_inverter_power">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">AC Input Power</span>
                <span class="metric-value" id="multiplus_acin_power">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">Power Factor</span>
                <span class="metric-value" id="multiplus_power_factor">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Temperature</span>
                <span class="metric-value" id="multiplus_temperature">--- ¬∞C</span>
            </div>
            <div class="metric">
                <span class="metric-label">Status</span>
                <span class="metric-value" id="multiplus_status">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Current Limit</span>
                <span class="metric-value" id="multiplus_current_limit">--- A</span>
            </div>
        </div>

        <!-- ESS Power Flow Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üîÑ</div>
                <div class="card-title">ESS Power Flow</div>
            </div>
            <div class="power-flow" id="ess_power">--- W</div>
            <div class="power-direction" id="power_direction">Standby</div>
            <div class="metric">
                <span class="metric-label">Switch Mode</span>
                <span class="metric-value" id="switch_mode">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Strategy</span>
                <span class="metric-value" id="strategy">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Min Strategy Time</span>
                <span class="metric-value" id="min_strategy_time">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Max Strategy Time</span>
                <span class="metric-value" id="max_strategy_time">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg BMS Power</span>
                <span class="metric-value" id="avg_bms_power">--- W</span>
            </div>
        </div>

        <!-- System Status Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üåê</div>
                <div class="card-title">System Status</div>
            </div>
            <div class="metric">
                <span class="metric-label">Current Time</span>
                <span class="metric-value" id="current_time">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">VE.Bus Status</span>
                <span class="metric-value">
                    <span class="status-indicator" id="vebus-indicator"></span>
                    <span id="vebus_online">---</span>
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">VE.Bus Quality</span>
                <span class="metric-value" id="vebus_quality">---%</span>
            </div>
            <div class="metric">
                <span class="metric-label">Frames Sent</span>
                <span class="metric-value" id="vebus_frames_sent">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Frames Received</span>
                <span class="metric-value" id="vebus_frames_received">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Communication Errors</span>
                <span class="metric-value" id="vebus_errors">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">LED Mode</span>
                <span class="metric-value" id="statusLED_mode">---</span>
            </div>
        </div>

        <!-- Feed-in Power Control Card -->
        <div class="card wide-card">
            <div class="card-header">
                <div class="card-icon system-icon">‚ö°</div>
                <div class="card-title">Einspeiseleistungs-Regelung</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                    <div class="metric">
                        <span class="metric-label">Status</span>
                        <span class="metric-value" id="feedin_status">---</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Aktuelle Leistung</span>
                        <span class="metric-value" id="feedin_current">--- W</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ziel-Leistung</span>
                        <span class="metric-value" id="feedin_target">--- W</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Max. Leistung</span>
                        <span class="metric-value" id="feedin_max">--- W</span>
                    </div>
                </div>
                <div>
                    <form id="feedin_form" style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500; color: var(--victron-dark-gray);">
                                <input type="checkbox" id="feedin_enabled" style="margin-right: 0.5rem;">
                                Regelung aktivieren
                            </label>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--victron-dark-gray);">Ziel-Einspeiseleistung (W):</label>
                            <input type="number" id="feedin_target_input" min="0" max="10000" step="50" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--victron-dark-gray);">Max. Einspeiseleistung (W):</label>
                            <input type="number" id="feedin_max_input" min="100" max="10000" step="100" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--victron-blue); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.3s;">
                            Einstellungen √ºbernehmen
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Protection & Warnings Card -->
        <div class="card wide-card">
            <div class="card-header">
                <div class="card-icon protection-icon">‚ö†Ô∏è</div>
                <div class="card-title">Battery Protection & Warnings</div>
            </div>
            <div class="metric">
                <span class="metric-label">Protection Flags 1</span>
                <span class="metric-value" id="battery_protection1">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Protection Flags 2</span>
                <span class="metric-value" id="battery_protection2">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Warning Flags 1</span>
                <span class="metric-value" id="battery_warning1">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Warning Flags 2</span>
                <span class="metric-value" id="battery_warning2">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Request Flags</span>
                <span class="metric-value" id="battery_request">---</span>
            </div>
        </div>

        <!-- Control & Diagnostics Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üéõÔ∏è</div>
                <div class="card-title">Control & Diagnostics</div>
            </div>
            <div class="metric">
                <span class="metric-label">Minimum Feed-in</span>
                <span class="metric-value" id="minimum_feedin">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Control Deviation</span>
                <span class="metric-value" id="avg_ctrl_deviation">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Charging Power</span>
                <span class="metric-value" id="avg_charging_power">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">15min Consumption Trend</span>
                <span class="metric-value" id="power_trend_cons">--- Wh</span>
            </div>
            <div class="metric">
                <span class="metric-label">15min Feed-in Trend</span>
                <span class="metric-value" id="power_trend_feed">--- Wh</span>
            </div>
            <div style="margin-top: 1rem;">
                <button class="button" onclick="shortPress()" style="margin-right: 0.5rem;">Short Press</button>
                <button class="button" onclick="longPress()">Long Press</button>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="manualRefresh()" title="Refresh Data">‚Üª</button>

    <div class="footer">
        <p>Victron Energy ESP32 ESS Controller</p>
        <p>
            <a href="/logfileAll.txt" style="color: var(--victron-blue); margin-right: 1rem;">Complete Log</a>
            <a href="/logfileFew.txt" style="color: var(--victron-blue); margin-right: 1rem;">Summary Log</a>
            <a href="/update" style="color: var(--victron-blue);">OTA Update</a>
        </p>
    </div>

    <script>
        let ws;
        let lastUpdateTime = 0;
        
        function connectWS() {
            ws = new WebSocket('ws://' + location.hostname + '/ws');
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateAllValues(data);
                lastUpdateTime = Date.now();
            };
            ws.onclose = function() {
                setTimeout(connectWS, 2000);
            };
            ws.onerror = function() {
                console.log('WebSocket error');
            };
        }
        
        function updateAllValues(data) {
            // Battery Status
            const soc = data.battery_soc || 0;
            document.getElementById('battery_soc').textContent = soc + '%';
            document.getElementById('battery_voltage').textContent = (data.battery_voltage || '?') + ' V';
            document.getElementById('battery_current').textContent = (data.battery_current || '?') + ' A';
            document.getElementById('battery_temperature').textContent = (data.battery_temperature || '?') + ' ¬∞C';
            document.getElementById('battery_soh').textContent = (data.battery_soh || '?') + '%';
            document.getElementById('battery_charge_voltage').textContent = (data.battery_chargeVoltage || '?') + ' V';
            document.getElementById('battery_charge_current_limit').textContent = (data.battery_chargeCurrentLimit || '?') + ' A';
            document.getElementById('battery_discharge_current_limit').textContent = (data.battery_dischargeCurrentLimit || '?') + ' A';
            document.getElementById('battery_manufacturer').textContent = data.battery_manufacturer || '---';
            
            // Update battery SOC progress bar
            const progressBar = document.getElementById('battery-progress');
            progressBar.style.width = Math.max(0, Math.min(100, soc)) + '%';
            
            // Change color based on SOC
            if (soc > 70) {
                progressBar.style.background = 'linear-gradient(90deg, var(--victron-green), #20C997)';
            } else if (soc > 30) {
                progressBar.style.background = 'linear-gradient(90deg, var(--victron-orange), #FFB347)';
            } else {
                progressBar.style.background = 'linear-gradient(90deg, var(--victron-red), #FF6B6B)';
            }
            
            // MultiPlus Data
            document.getElementById('multiplus_dc_voltage').textContent = (data.multiplusDcVoltage || '?') + ' V';
            document.getElementById('multiplus_dc_current').textContent = (data.multiplusDcCurrent || '?') + ' A';
            document.getElementById('multiplus_ac_voltage').textContent = (data.multiplusUMainsRMS || '?') + ' V';
            document.getElementById('multiplus_ac_frequency').textContent = (data.multiplusAcFrequency || '?') + ' Hz';
            document.getElementById('multiplus_inverter_power').textContent = (data.multiplusPinverterFiltered || '?') + ' W';
            document.getElementById('multiplus_acin_power').textContent = (data.multiplusPmainsFiltered || '?') + ' W';
            document.getElementById('multiplus_power_factor').textContent = data.multiplusPowerFactor || '---';
            document.getElementById('multiplus_temperature').textContent = (data.multiplusTemp || '?') + ' ¬∞C';
            document.getElementById('multiplus_status').textContent = data.multiplusStatus80 || '---';
            document.getElementById('multiplus_current_limit').textContent = (data.masterMultiLED_ActualInputCurrentLimit || '?') + ' A';
            
            // ESS Power Flow
            const essPower = data.multiplusESSpower || 0;
            document.getElementById('ess_power').textContent = Math.abs(essPower) + ' W';
            const powerDirection = document.getElementById('power_direction');
            if (essPower > 100) {
                powerDirection.textContent = 'Charging';
                document.getElementById('ess_power').style.color = 'var(--victron-green)';
            } else if (essPower < -100) {
                powerDirection.textContent = 'Discharging';
                document.getElementById('ess_power').style.color = 'var(--victron-orange)';
            } else {
                powerDirection.textContent = 'Standby';
                document.getElementById('ess_power').style.color = 'var(--victron-blue)';
            }
            
            document.getElementById('switch_mode').textContent = data.switchMode || '---';
            document.getElementById('strategy').textContent = data.essPowerStrategy || '---';
            document.getElementById('min_strategy_time').textContent = formatTime(data.secondsInMinStrategy || 0);
            document.getElementById('max_strategy_time').textContent = formatTime(data.secondsInMaxStrategy || 0);
            document.getElementById('avg_bms_power').textContent = Math.round(data.bmsPowerAverage || 0) + ' W';
            
            // System Status
            const currentTime = new Date();
            document.getElementById('current_time').textContent = currentTime.toLocaleTimeString();
            
            // VE.Bus Status
            const vebusIndicator = document.getElementById('vebus-indicator');
            const vebusOnline = data.veBus_isOnline;
            document.getElementById('vebus_online').textContent = vebusOnline ? 'Online' : 'Offline';
            vebusIndicator.className = 'status-indicator ' + (vebusOnline ? 'status-online' : 'status-offline');
            document.getElementById('vebus_quality').textContent = Math.round((data.veBus_communicationQuality || 0) * 100) + '%';
            document.getElementById('vebus_frames_sent').textContent = data.veBus_framesSent || '0';
            document.getElementById('vebus_frames_received').textContent = data.veBus_framesReceived || '0';
            document.getElementById('vebus_errors').textContent = ((data.veBus_checksumErrors || 0) + (data.veBus_timeoutErrors || 0));
            
            // Status LED
            const ledModes = ['Boot', 'WiFi Connecting', 'WiFi Connected', 'Normal Operation', 'Error'];
            document.getElementById('statusLED_mode').textContent = ledModes[data.statusLED_mode] || 'Unknown';
            
            // Feed-in Power Control
            const feedInEnabled = data.feedInControl_enabled || false;
            document.getElementById('feedin_status').textContent = feedInEnabled ? 'Aktiv' : 'Inaktiv';
            document.getElementById('feedin_status').style.color = feedInEnabled ? 'var(--victron-green)' : 'var(--victron-red)';
            document.getElementById('feedin_current').textContent = Math.round(data.feedInControl_current || 0) + ' W';
            document.getElementById('feedin_target').textContent = Math.round(data.feedInControl_target || 0) + ' W';
            document.getElementById('feedin_max').textContent = Math.round(data.feedInControl_max || 0) + ' W';
            
            // Update form inputs if not currently being edited
            if (!document.getElementById('feedin_enabled').matches(':focus')) {
                document.getElementById('feedin_enabled').checked = feedInEnabled;
            }
            if (!document.getElementById('feedin_target_input').matches(':focus')) {
                document.getElementById('feedin_target_input').value = Math.round(data.feedInControl_target || 0);
            }
            if (!document.getElementById('feedin_max_input').matches(':focus')) {
                document.getElementById('feedin_max_input').value = Math.round(data.feedInControl_max || 5000);
            }
            
            // Protection & Warnings
            document.getElementById('battery_protection1').textContent = '0x' + (data.battery_protectionFlags1 ? data.battery_protectionFlags1.toString(16).toUpperCase() : '?');
            document.getElementById('battery_protection2').textContent = '0x' + (data.battery_protectionFlags2 ? data.battery_protectionFlags2.toString(16).toUpperCase() : '?');
            document.getElementById('battery_warning1').textContent = '0x' + (data.battery_warningFlags1 ? data.battery_warningFlags1.toString(16).toUpperCase() : '?');
            document.getElementById('battery_warning2').textContent = '0x' + (data.battery_warningFlags2 ? data.battery_warningFlags2.toString(16).toUpperCase() : '?');
            document.getElementById('battery_request').textContent = '0x' + (data.battery_requestFlags ? data.battery_requestFlags.toString(16).toUpperCase() : '?');
            
            // Control & Diagnostics
            document.getElementById('minimum_feedin').textContent = (data.minimumFeedIn || '?') + ' W';
            document.getElementById('avg_ctrl_deviation').textContent = (data.averageControlDeviationFeedIn || '?') + ' W';
            document.getElementById('avg_charging_power').textContent = (data.averageChargingPower || '?') + ' W';
            document.getElementById('power_trend_cons').textContent = (data.powerTrendConsumption || '?') + ' Wh';
            document.getElementById('power_trend_feed').textContent = (data.powerTrendFeedIn || '?') + ' Wh';
        }
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0') + ':' + s.toString().padStart(2, '0');
        }
        
        function formatTimeFromSeconds(totalSeconds) {
            const timeOffset = 9*60*60 + 57*60 + 7; // ELECTRIC_METER_TIME_OFFSET
            const adjustedSeconds = totalSeconds + timeOffset;
            const h = Math.floor((adjustedSeconds % (24*60*60)) / 3600);
            const m = Math.floor((adjustedSeconds % 3600) / 60);
            const s = adjustedSeconds % 60;
            return h.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0') + ':' + s.toString().padStart(2, '0');
        }
        
        function shortPress() {
            fetch('/shortpress').catch(e => console.log('Short press failed:', e));
        }
        
        function longPress() {
            fetch('/longpress').catch(e => console.log('Long press failed:', e));
        }
        
        function manualRefresh() {
            // Visual feedback
            const btn = document.querySelector('.refresh-btn');
            btn.style.transform = 'scale(0.9) rotate(180deg)';
            setTimeout(() => {
                btn.style.transform = 'scale(1) rotate(0deg)';
            }, 200);
            
            // Reconnect WebSocket if needed
            if (ws.readyState !== WebSocket.OPEN) {
                connectWS();
            }
        }
        
        // Feed-in control form handler
        document.getElementById('feedin_form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const enabled = document.getElementById('feedin_enabled').checked;
            const target = parseFloat(document.getElementById('feedin_target_input').value) || 0;
            const max = parseFloat(document.getElementById('feedin_max_input').value) || 5000;
            
            const formData = new FormData();
            formData.append('enabled', enabled ? 'true' : 'false');
            formData.append('target', target);
            formData.append('max', max);
            
            fetch('/api/feedin', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Feed-in control updated:', data);
                // Update will be reflected through WebSocket
            })
            .catch(error => {
                console.error('Error updating feed-in control:', error);
                alert('Fehler beim Aktualisieren der Einstellungen: ' + error.message);
            });
        });
        
        // Auto-connect on page load
        window.onload = connectWS;
    </script>
</body>
</html>
