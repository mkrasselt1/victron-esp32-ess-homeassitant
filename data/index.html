<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victron ESS Controller</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="header">
        <h1>Victron Energy ESS Controller</h1>
        <div class="subtitle">ESP32 MultiPlus Energy Storage System</div>
    </div>

    <div class="container">
        <!-- Battery Status Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon battery-icon">üîã</div>
                <div class="card-title">Battery Management System</div>
            </div>
            <div class="metric">
                <span class="metric-label">State of Charge</span>
                <span class="metric-value" id="battery_soc">---%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="battery-progress" style="width: 0%"></div>
            </div>
            <div class="metric">
                <span class="metric-label">Voltage</span>
                <span class="metric-value" id="battery_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">Current</span>
                <span class="metric-value" id="battery_current">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Temperature</span>
                <span class="metric-value" id="battery_temperature">--- ¬∞C</span>
            </div>
            <div class="metric">
                <span class="metric-label">State of Health</span>
                <span class="metric-value" id="battery_soh">---%</span>
            </div>
            <div class="metric">
                <span class="metric-label">Charge Voltage Limit</span>
                <span class="metric-value" id="battery_charge_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">Charge Current Limit</span>
                <span class="metric-value" id="battery_charge_current_limit">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Discharge Current Limit</span>
                <span class="metric-value" id="battery_discharge_current_limit">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">Manufacturer</span>
                <span class="metric-value" id="battery_manufacturer">---</span>
            </div>
        </div>

        <!-- MultiPlus Inverter Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon inverter-icon">‚ö°</div>
                <div class="card-title">MultiPlus Inverter/Charger</div>
            </div>
            <div class="metric">
                <span class="metric-label">DC Voltage</span>
                <span class="metric-value" id="multiplus_dc_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">DC Current</span>
                <span class="metric-value" id="multiplus_dc_current">--- A</span>
            </div>
            <div class="metric">
                <span class="metric-label">AC Voltage (RMS)</span>
                <span class="metric-value" id="multiplus_ac_voltage">--- V</span>
            </div>
            <div class="metric">
                <span class="metric-label">AC Frequency</span>
                <span class="metric-value" id="multiplus_ac_frequency">--- Hz</span>
            </div>
            <div class="metric">
                <span class="metric-label">Inverter Power</span>
                <span class="metric-value" id="multiplus_inverter_power">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">AC Input Power</span>
                <span class="metric-value" id="multiplus_acin_power">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">Power Factor</span>
                <span class="metric-value" id="multiplus_power_factor">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Temperature</span>
                <span class="metric-value" id="multiplus_temperature">--- ¬∞C</span>
            </div>
            <div class="metric">
                <span class="metric-label">Status</span>
                <span class="metric-value" id="multiplus_status">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Current Limit</span>
                <span class="metric-value" id="multiplus_current_limit">--- A</span>
            </div>
        </div>

        <!-- ESS Power Flow Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üîÑ</div>
                <div class="card-title">ESS Power Flow</div>
            </div>
            <div class="power-flow" id="ess_power">--- W</div>
            <div class="power-direction" id="power_direction">Standby</div>
            <div class="metric">
                <span class="metric-label">Switch Mode</span>
                <span class="metric-value" id="switch_mode">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Strategy</span>
                <span class="metric-value" id="strategy">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Min Strategy Time</span>
                <span class="metric-value" id="min_strategy_time">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Max Strategy Time</span>
                <span class="metric-value" id="max_strategy_time">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg BMS Power</span>
                <span class="metric-value" id="avg_bms_power">--- W</span>
            </div>
        </div>

        <!-- System Status Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üåê</div>
                <div class="card-title">System Status</div>
            </div>
            <div class="metric">
                <span class="metric-label">Current Time</span>
                <span class="metric-value" id="current_time">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">VE.Bus Status</span>
                <span class="metric-value">
                    <span class="status-indicator" id="vebus-indicator"></span>
                    <span id="vebus_online">---</span>
                </span>
            </div>
            <div class="metric">
                <span class="metric-label">VE.Bus Quality</span>
                <span class="metric-value" id="vebus_quality">---%</span>
            </div>
            <div class="metric">
                <span class="metric-label">Frames Sent</span>
                <span class="metric-value" id="vebus_frames_sent">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Frames Received</span>
                <span class="metric-value" id="vebus_frames_received">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Communication Errors</span>
                <span class="metric-value" id="vebus_errors">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">LED Mode</span>
                <span class="metric-value" id="statusLED_mode">---</span>
            </div>
        </div>

        <!-- Feed-in Power Control Card -->
        <div class="card wide-card">
            <div class="card-header">
                <div class="card-icon system-icon">‚ö°</div>
                <div class="card-title">Einspeiseleistungs-Regelung</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                <div>
                    <div class="metric">
                        <span class="metric-label">Status</span>
                        <span class="metric-value" id="feedin_status">---</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Aktuelle Leistung</span>
                        <span class="metric-value" id="feedin_current">--- W</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Ziel-Leistung</span>
                        <span class="metric-value" id="feedin_target">--- W</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Max. Leistung</span>
                        <span class="metric-value" id="feedin_max">--- W</span>
                    </div>
                </div>
                <div>
                    <form id="feedin_form" style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label style="font-weight: 500; color: var(--victron-dark-gray);">
                                <input type="checkbox" id="feedin_enabled" style="margin-right: 0.5rem;">
                                Regelung aktivieren
                            </label>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--victron-dark-gray);">Ziel-Einspeiseleistung (W):</label>
                            <input type="number" id="feedin_target_input" min="0" max="10000" step="50" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--victron-dark-gray);">Max. Einspeiseleistung (W):</label>
                            <input type="number" id="feedin_max_input" min="100" max="10000" step="100" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                        </div>
                        <button type="submit" style="padding: 0.75rem 1.5rem; background: var(--victron-blue); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.3s;">
                            Einstellungen √ºbernehmen
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- MQTT Status Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üì°</div>
                <div class="card-title">MQTT-Integration</div>
            </div>
            <div class="metric">
                <span class="metric-label">Verbindungsstatus</span>
                <span class="metric-value" id="mqtt_status">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Server</span>
                <span class="metric-value" id="mqtt_server_display">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Port</span>
                <span class="metric-value" id="mqtt_port_display">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Letzte Nachricht</span>
                <span class="metric-value" id="mqtt_last_message">---</span>
            </div>
            <div style="margin-top: 1rem;">
                <button onclick="openMqttModal()" style="padding: 0.75rem 1.5rem; background: var(--victron-blue); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.3s; width: 100%;">
                    MQTT konfigurieren
                </button>
            </div>
            <div style="margin-top: 1rem; padding: 1rem; background: var(--victron-gray); border-radius: 8px; font-size: 0.85rem;">
                <strong>MQTT Topics:</strong><br>
                ‚Ä¢ Publishing: <code>ess/battery/soc</code>, <code>ess/multiplus/power</code><br>
                ‚Ä¢ Subscribing: <code>ess/feedin/enabled</code>, <code>ess/feedin/target</code>
            </div>
        </div>

        <!-- Protection & Warnings Card -->
        <div class="card wide-card">
            <div class="card-header">
                <div class="card-icon protection-icon">‚ö†Ô∏è</div>
                <div class="card-title">Battery Protection & Warnings</div>
            </div>
            <div class="metric">
                <span class="metric-label">Protection Flags 1</span>
                <span class="metric-value" id="battery_protection1">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Protection Flags 2</span>
                <span class="metric-value" id="battery_protection2">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Warning Flags 1</span>
                <span class="metric-value" id="battery_warning1">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Warning Flags 2</span>
                <span class="metric-value" id="battery_warning2">---</span>
            </div>
            <div class="metric">
                <span class="metric-label">Request Flags</span>
                <span class="metric-value" id="battery_request">---</span>
            </div>
        </div>

        <!-- Control & Diagnostics Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon system-icon">üéõÔ∏è</div>
                <div class="card-title">Control & Diagnostics</div>
            </div>
            <div class="metric">
                <span class="metric-label">Minimum Feed-in</span>
                <span class="metric-value" id="minimum_feedin">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Control Deviation</span>
                <span class="metric-value" id="avg_ctrl_deviation">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Charging Power</span>
                <span class="metric-value" id="avg_charging_power">--- W</span>
            </div>
            <div class="metric">
                <span class="metric-label">15min Consumption Trend</span>
                <span class="metric-value" id="power_trend_cons">--- Wh</span>
            </div>
            <div class="metric">
                <span class="metric-label">15min Feed-in Trend</span>
                <span class="metric-value" id="power_trend_feed">--- Wh</span>
            </div>
            <div style="margin-top: 1rem;">
                <button class="button" onclick="shortPress()" style="margin-right: 0.5rem;">Short Press</button>
                <button class="button" onclick="longPress()">Long Press</button>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="manualRefresh()" title="Manual Refresh">üîÑ</button>

    <div class="footer">
        <p>Victron Energy ESP32 ESS Controller</p>
        <p>
            <a href="/update" style="color: var(--victron-blue);">OTA Update</a>
        </p>
    </div>

    <!-- MQTT Configuration Modal -->
    <div id="mqttModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì° MQTT-Konfiguration</h2>
                <button class="modal-close" onclick="closeMqttModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="mqtt_modal_form" class="modal-form">
                    <div class="modal-form-group">
                        <label for="mqtt_server_input">MQTT-Server *</label>
                        <input type="text" id="mqtt_server_input" placeholder="192.168.30.1 oder mqtt.example.com" required>
                    </div>
                    
                    <div class="modal-form-group">
                        <label for="mqtt_port_input">Port</label>
                        <input type="number" id="mqtt_port_input" min="1" max="65535" value="1883" required>
                    </div>
                    
                    <div class="modal-form-group">
                        <label for="mqtt_username_input">Benutzername (optional)</label>
                        <input type="text" id="mqtt_username_input" placeholder="Leer lassen wenn nicht ben√∂tigt">
                    </div>
                    
                    <div class="modal-form-group">
                        <label for="mqtt_password_input">Passwort (optional)</label>
                        <input type="password" id="mqtt_password_input" placeholder="Leer lassen wenn nicht ben√∂tigt">
                    </div>
                    
                    <div style="background: var(--victron-gray); padding: 1rem; border-radius: 8px; font-size: 0.9rem; margin-top: 1rem;">
                        <strong>üìã MQTT Topics:</strong><br>
                        <strong>Publishing:</strong> <code>ess/battery/soc</code>, <code>ess/multiplus/power</code><br>
                        <strong>Subscribing:</strong> <code>ess/feedin/enabled</code>, <code>ess/feedin/target</code>
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="modal-btn modal-btn-secondary" onclick="closeMqttModal()">
                            Abbrechen
                        </button>
                        <button type="submit" class="modal-btn modal-btn-primary">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/script.js"></script>
</body>
</html>